<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Freight Simulation</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
        }

        .log {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding: 5px;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>Freight Simulation</h1>
    <div id="results">Running...</div>

    <script>
        const CONFIG = {
            active: true,
            origin_cep: "01030-001",
            pricing_table: {
                "1": 10, "2": 2.5, "3": 2.5, "4": 2.5, "5": 2.5,
                "6": 2.5, "7": 2.5, "8": 2.5, "9": 2, "10": 2,
                "11": 2, "12": 2, "13": 2, "14": 2, "15": 2,
                "16": 1.5, "17": 1.5, "18": 1.5, "19": 1.5, "20": 1.3,
                "21": 1.3, "22": 1.3, "23": 1.3, "24": 1.3, "25": 1.3,
                "26": 1, "27": 1, "28": 1, "29": 1, "30": 1,
                "31": 1, "32": 1, "33": 1, "34": 1, "35": 1,
                "36": 1, "37": 1, "38": 1, "39": 1, "40": 1,
                "41": 1, "42": 1, "43": 1, "44": 1, "45": 1,
                "46": 1, "47": 1, "48": 1, "49": 1, "50": 1
            }
        };

        const TEST_CEPS = [
            { cep: "01310-100", name: "Av Paulista" },
            { cep: "05425-902", name: "Pinheiros (Failed Before)" },
            { cep: "04538-133", name: "Itaim Bibi" },
            { cep: "02011-200", name: "Santana" },
            { cep: "03001-000", name: "Brás" },
            { cep: "04001-001", name: "Vila Mariana (Failed Before)" },
            { cep: "05001-100", name: "Perdizes" },
            { cep: "03178-200", name: "Mooca" },
            { cep: "04707-910", name: "Brooklin (Failed Before)" },
            { cep: "08246-101", name: "Itaquera (User Reported)" },
            // Adding 5 more to reach 15
            { cep: "01532-001", name: "Aclimação" },
            { cep: "01221-000", name: "Vila Buarque" },
            { cep: "04101-000", name: "Vila Mariana (Outro)" },
            { cep: "03310-000", name: "Tatuapé" },
            { cep: "05501-010", name: "Butantã" }
        ];

        // Fetch Address from ViaCEP (to simulate the Address object)
        async function getAddressByCep(cep) {
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (data.erro) return null;
                return {
                    street: data.logradouro,
                    neighborhood: data.bairro,
                    city: data.localidade,
                    state: data.uf,
                    cep: data.cep
                };
            } catch (e) {
                console.error('ViaCEP Error:', e);
                return null;
            }
        }

        async function getCoordinates(cep) {
            try {
                // 1. Try by CEP
                const cleanCep = cep.replace(/\D/g, '');
                let url = `https://nominatim.openstreetmap.org/search?postalcode=${cleanCep}&country=Brazil&format=json&limit=1`;

                // Add delay to avoid rate limiting
                await new Promise(r => setTimeout(r, 1500));

                let response = await fetch(url, {
                    headers: { 'User-Agent': 'SevenOutletDebug/1.0' }
                });
                let data = await response.json();

                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), source: 'CEP' };
                }

                // 2. Fallback: Get Address first, then search by Address
                console.log(`Fallback for ${cep}...`);
                const address = await getAddressByCep(cep);
                if (!address) return null;

                const query = `${address.street}, ${address.city}, ${address.state}, Brazil`;
                url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;

                await new Promise(r => setTimeout(r, 1500));

                response = await fetch(url, {
                    headers: { 'User-Agent': 'SevenOutletDebug/1.0' }
                });
                data = await response.json();

                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), source: 'ADDRESS_FALLBACK' };
                }

                return null;
            } catch (error) {
                console.error('Error fetching coordinates:', error);
                return null;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function runSimulation() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = 'Running... (This may take a minute due to rate limits)<br><br>';

            const originCoords = await getCoordinates(CONFIG.origin_cep);

            if (!originCoords) {
                resultsDiv.innerHTML += `<div class="log error">Failed to get Origin Coordinates for ${CONFIG.origin_cep}</div>`;
                return;
            }

            resultsDiv.innerHTML += `<div class="log success">Origin: ${CONFIG.origin_cep} (${originCoords.lat}, ${originCoords.lon})</div>`;

            for (const test of TEST_CEPS) {
                resultsDiv.innerHTML += `... Checking ${test.cep}<br>`;
                const destCoords = await getCoordinates(test.cep);

                if (!destCoords) {
                    resultsDiv.innerHTML += `<div class="log error">[${test.cep} - ${test.name}] Failed to get coordinates (Both methods failed)</div>`;
                    continue;
                }

                const distance = calculateDistance(originCoords.lat, originCoords.lon, destCoords.lat, destCoords.lon);

                let totalPrice = 0;
                const maxKm = Math.ceil(distance);
                let breakdown = [];

                for (let i = 1; i <= maxKm; i++) {
                    const kmKey = i.toString();
                    let kmPrice = 0;

                    if (CONFIG.pricing_table[kmKey]) {
                        kmPrice = parseFloat(CONFIG.pricing_table[kmKey]);
                    } else {
                        // Fallback logic from api.js
                        const keys = Object.keys(CONFIG.pricing_table).map(k => parseInt(k)).sort((a, b) => a - b);
                        const lastKey = keys[keys.length - 1];
                        if (lastKey && i > lastKey) {
                            kmPrice = parseFloat(CONFIG.pricing_table[lastKey.toString()]);
                        }
                    }
                    totalPrice += kmPrice;
                }

                resultsDiv.innerHTML += `
                    <div class="log ${totalPrice > 0 ? 'success' : 'error'}">
                        <strong>${test.cep} - ${test.name}</strong><br>
                        Source: ${destCoords.source}<br>
                        Coords: ${destCoords.lat}, ${destCoords.lon}<br>
                        Distance: ${distance.toFixed(2)} km<br>
                        Price: R$ ${totalPrice.toFixed(2)}
                    </div>
                `;
            }
            resultsDiv.innerHTML += '<br><strong>Done!</strong>';
        }

        runSimulation();
    </script>
</body>

</html>