<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Admin SEVEN</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="overlay" id="mobile-overlay"></div>

        <!-- DEBUG BAR -->
        <div id="debug-bar"
            style="background: #ffebee; color: #c62828; padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #ffcdd2;">
            <i class="fas fa-bug"></i> Debug Iniciando...
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="margin: 0;">SEVEN<span style="color: var(--color-red);">.</span></h3>
                <p style="font-size: 0.8rem; color: #666;">Painel Administrativo</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                <li><a href="products.html"><i class="fas fa-box"></i> Produtos</a></li>
                <li><a href="categories.html"><i class="fas fa-tags"></i> Categorias</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Usu√°rios</a></li>
                <li><a href="freight.html"><i class="fas fa-truck"></i> Frete</a></li>
                <li><a href="banners.html"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="#" onclick="openSecurityModal()"><i class="fas fa-shield-alt"></i> Seguran√ßa / 2FA</a></li>
                <li><a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="db.logout(); window.location.href='../login.html'"
                    style="color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="text-display">Dashboard</h2>
            </div>

            <div class="dashboard-cards">
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Total de Produtos</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="total-products">0</p>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Total de Pedidos</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="total-orders">0</p>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Usu√°rios Cadastrados</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="total-users">0</p>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Vendas (Hoje)</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="today-sales">R$ 0,00</p>
                </div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px;">A√ß√µes R√°pidas</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <a href="products.html" class="btn-primary" style="text-decoration: none;">Gerenciar Produtos</a>
                    <a href="categories.html" class="btn-primary"
                        style="text-decoration: none; background: #555;">Gerenciar
                        Categorias</a>
                    <button onclick="recoverData()" class="btn-primary" style="background: #dc3545;">Recuperar Dados de
                        Demonstra√ß√£o</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Security Modal (2FA) -->
    <div id="security-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSecurityModal()">&times;</span>
            <h3 style="margin-bottom: 20px;">Configurar 2FA</h3>

            <div id="mfa-step-1">
                <p>Escaneie o QR Code abaixo com seu aplicativo (Google Authenticator).</p>
                <div id="mfa-qr" style="margin: 20px 0; text-align: center;">Loading...</div>
                <div class="form-group">
                    <label>C√≥digo de Verifica√ß√£o (6 d√≠gitos)</label>
                    <input type="text" id="mfa-verify-code" placeholder="123456" maxlength="6">
                </div>
                <button onclick="enableMFA()" class="btn-primary" style="width: 100%;">Ativar 2FA</button>
            </div>

            <div id="mfa-step-success" style="display: none; text-align: center;">
                <i class="fas fa-check-circle" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                <h4>2FA Ativado com Sucesso!</h4>
                <p>Agora seus logins pedir√£o esse c√≥digo.</p>
                <button onclick="closeSecurityModal()" class="admin-btn-secondary"
                    style="margin-top: 15px;">Fechar</button>
            </div>

            <div id="mfa-active-msg" style="display: none; text-align: center; padding: 20px;">
                <i class="fas fa-shield-alt" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                <h4>Voc√™ j√° est√° protegido!</h4>
                <p>A Autentica√ß√£o de Dois Fatores est√° ativa nesta conta.</p>
            </div>

            <div class="error-msg" id="mfa-error" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-init.js"></script>
    <script src="../assets/js/db.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/main.js"></script>

    <script>
        // Debug Logic (Safe Mode)
        async function runDebug() {
            const el = document.getElementById('debug-bar');
            if (!el) return;

            el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';

            try {
                // Wait for Supabase to be ready from supabase-init.js
                // If it fails there, we catch it here.
                if (!window.supabaseClient) {
                    // Try Emergency Direct Init
                    const SB_URL = 'https://bwpskigahszxkgzxtewf.supabase.co';
                    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3cHNraWdhaHN6eGtnenh0ZXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDQzMDgsImV4cCI6MjA4MDI4MDMwOH0.D99euPduBI0kJuE0u3Yw4fJCsvT5LSyO4VTbtbY3TD0';
                    if (typeof supabase !== 'undefined') {
                        window.supabaseClient = supabase.createClient(SB_URL, SB_KEY);
                    } else {
                        throw new Error("Supabase JS Library not found");
                    }
                }

                const client = window.supabaseClient;

                // 1. Check Session
                const { data: { session }, error: sessionError } = await client.auth.getSession();

                if (sessionError) throw sessionError;

                if (!session) {
                    el.innerHTML = 'Status: <strong>N√ÉO LOGADO</strong>. Fa√ßa login novamente.';
                    return;
                }

                const user = session.user;

                // 2. Check Profile
                const { data: profile, error: profileError } = await client
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') {
                    el.innerHTML = `LOGADO: ${user.email} | Erro Profile: ${profileError.message}`;
                    return;
                }

                const role = profile ? profile.role : 'NENHUM (Sem Perfil)';

                el.innerHTML = `‚úÖ CONECTADO | Email: ${user.email} | Role: <strong>${role}</strong>`;

                if (role !== 'admin') {
                    el.style.backgroundColor = '#ffcdd2';
                    el.innerHTML += ' <br> üõë <strong>N√ÉO √â ADMIN!</strong> (Dados ocultos)';
                } else {
                    el.style.backgroundColor = '#c8e6c9';
                    el.style.color = '#2e7d32';
                    el.innerHTML += ' <br> ‚ú® Acesso OK!';
                }

            } catch (err) {
                console.error(err);
                el.innerHTML = `ERRO DEBUG: ${err.message}`;
            }
        }

        // Dashboard Stats
        async function loadDashboard() {
            try {
                // Ensure db is ready
                if (!window.db) window.db = new DB();

                const [products, users, orders] = await Promise.all([
                    db.getProducts(),
                    db.getUsers ? db.getUsers() : Promise.resolve([]), // Fallback if getUsers missing
                    db.getOrders()
                ]);

                document.getElementById('total-products').textContent = products ? products.length : 0;
                document.getElementById('total-users').textContent = users ? users.length : 0;
                document.getElementById('total-orders').textContent = orders ? orders.length : 0;

                // Sales
                if (orders && orders.length > 0) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayOrders = orders.filter(o => o.created_at && o.created_at.startsWith(today));
                    const totalSales = todayOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
                    document.getElementById('today-sales').textContent = `R$ ${totalSales.toFixed(2).replace('.', ',')}`;
                }

            } catch (error) {
                console.error("Dashboard Load Error:", error);
            }
        }

        // Mobile Logic
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');

        if (mobileBtn) {
            mobileBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
        }
        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        function recoverData() {
            if (confirm('Restaurar dados de demonstra√ß√£o?')) {
                if (db.resetData) {
                    db.resetData();
                    alert('Dados restaurados!');
                    window.location.reload();
                } else {
                    alert('Fun√ß√£o n√£o dispon√≠vel.');
                }
            }
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            runDebug();
            loadDashboard();
        });

    </script>
</body>

</html>