<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Admin SEVEN</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="overlay" id="mobile-overlay"></div>

        <!-- DEBUG BAR (Temporary) -->
        <div id="debug-bar"
            style="background: #ffebee; color: #c62828; padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #ffcdd2;">
            <i class="fas fa-bug"></i> Debug Iniciando...
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="margin: 0;">SEVEN<span style="color: var(--color-red);">.</span></h3>
                <p style="font-size: 0.8rem; color: #666;">Painel Administrativo</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                <li><a href="products.html"><i class="fas fa-box"></i> Produtos</a></li>
                <li><a href="categories.html"><i class="fas fa-tags"></i> Categorias</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Usuários</a></li>
                <li><a href="freight.html"><i class="fas fa-truck"></i> Frete</a></li>
                <li><a href="banners.html"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="#" onclick="openSecurityModal()"><i class="fas fa-shield-alt"></i> Segurança / 2FA</a></li>
                <li><a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="db.logout(); window.location.href='../login.html'"
                    style="color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="text-display">Dashboard</h2>
            </div>

            <div class="dashboard-cards">
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Total de Produtos</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="total-products">0</p>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Total de Pedidos</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="total-orders">0</p>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Usuários Cadastrados</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="total-users">0</p>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">Vendas (Hoje)</h3>
                    <p class="text-display" style="font-size: 2.5rem;" id="today-sales">R$ 0,00</p>
                </div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px;">Ações Rápidas</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <a href="products.html" class="btn-primary" style="text-decoration: none;">Gerenciar Produtos</a>
                    <a href="categories.html" class="btn-primary"
                        style="text-decoration: none; background: #555;">Gerenciar
                        Categorias</a>
                    <button onclick="recoverData()" class="btn-primary" style="background: #dc3545;">Recuperar Dados de
                        Demonstração</button>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-init.js"></script>
    <script src="../assets/js/db.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        // Debug Logic
        async function runDebug() {
            const el = document.getElementById('debug-bar');
            try {
                // 1. Check Session
                const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();
                if (sessionError || !session) {
                    el.innerHTML = 'Status: Não logado (Session Null)';
                    return;
                }

                // 2. Check Profile
                const user = session.user;
                const { data: profile, error: profileError } = await window.supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profileError) {
                    el.innerHTML = `Logado: ${user.email} <br> Erro Profile: ${profileError.message} (Provável RLS)`;
                    return;
                }

                if (profile) {
                    el.innerHTML = `USER: ${user.email} | ID: ${user.id.slice(0, 5)}... | ROLE: <strong>${profile.role || 'NULO'}</strong>`;
                    if (profile.role !== 'admin') {
                        el.innerHTML += ' <br> (⚠️ VOCÊ NÃO É ADMIN! Rode o SQL para corrigir)';
                    }
                } else {
                    el.innerHTML = `Logado: ${user.email} <br> Profile não encontrado (Tabela vazia?)`;
                }

            } catch (err) {
                el.innerHTML = `Erro JS: ${err.message}`;
            }
        }

        // Mobile Toggle Logic
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');

        document.addEventListener('DOMContentLoaded', runDebug);

        if (mobileBtn) {
            mobileBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
        }

        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        // Dashboard Logic
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch data in parallel
                const [products, users, orders] = await Promise.all([
                    db.getProducts(),
                    db.getUsers(),
                    db.getOrders()
                ]);

                // Update Counts
                document.getElementById('total-products').textContent = products ? products.length : 0;
                document.getElementById('total-users').textContent = users ? users.length : 0;
                document.getElementById('total-orders').textContent = orders ? orders.length : 0;

                // Calculate Sales Today
                if (orders && orders.length > 0) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayOrders = orders.filter(order => {
                        if (!order.created_at) return false;
                        return order.created_at.startsWith(today);
                    });

                    const totalSales = todayOrders.reduce((sum, order) => {
                        return sum + (parseFloat(order.total) || 0);
                    }, 0);

                    document.getElementById('today-sales').textContent = `R$ ${totalSales.toFixed(2).replace('.', ',')}`;
                } else {
                    document.getElementById('today-sales').textContent = 'R$ 0,00';
                }

            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        });

        function recoverData() {
            if (confirm('ATENÇÃO: Isso irá apagar todos os dados atuais e restaurar os dados de demonstração originais. Deseja continuar?')) {
                if (db.resetData) {
                    const result = db.resetData();
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert('Função de reset não implementada no backend atual.');
                }
            }
        }
    <!-- Security Modal (2FA) -->
    <div id="security-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSecurityModal()">&times;</span>
            <h3 style="margin-bottom: 20px;">Configurar 2FA</h3>
            
            <div id="mfa-step-1">
                <p>Escaneie o QR Code abaixo com seu aplicativo (Google Authenticator).</p>
                <div id="mfa-qr" style="margin: 20px 0; text-align: center;">Loading...</div>
                <div class="form-group">
                    <label>Código de Verificação (6 dígitos)</label>
                    <input type="text" id="mfa-verify-code" placeholder="123456" maxlength="6">
                </div>
                <button onclick="enableMFA()" class="admin-btn-primary" style="width: 100%;">Ativar 2FA</button>
            </div>

            <div id="mfa-step-success" style="display: none; text-align: center;">
                <i class="fas fa-check-circle" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                <h4>2FA Ativado com Sucesso!</h4>
                <p>Agora seus logins pedirão esse código.</p>
                <button onclick="closeSecurityModal()" class="admin-btn-secondary" style="margin-top: 15px;">Fechar</button>
            </div>

            <div id="mfa-active-msg" style="display: none; text-align: center; padding: 20px;">
                <i class="fas fa-shield-alt" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                <h4>Você já está protegido!</h4>
                <p>A Autenticação de Dois Fatores está ativa nesta conta.</p>
            </div>
            
            <div class="error-msg" id="mfa-error" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!--Scripts -->
            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-init.js"></script>
    <script src="../assets/js/db.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/admin.js"></script>

    <script>
        // MFA Logic specific for Admin Dashboard

            // Define global for factorId
            window.mfaFactorId = null;

            async function openSecurityModal() {
            const modal = document.getElementById('security-modal');
            const step1 = document.getElementById('mfa-step-1');
            const stepSuccess = document.getElementById('mfa-step-success');
            const activeMsg = document.getElementById('mfa-active-msg');
            const qrContainer = document.getElementById('mfa-qr');

            modal.style.display = 'flex';

            // Instantiate api.js AuthService
            const auth = new AuthService();
            const enrolledFactors = await auth.listFactors();
            
            if (enrolledFactors.length > 0) {
                step1.style.display = 'none';
            stepSuccess.style.display = 'none';
            activeMsg.style.display = 'block';
            return;
            }

            // Not enrolled, start enrollment
            step1.style.display = 'block';
            stepSuccess.style.display = 'none';
            activeMsg.style.display = 'none';
            qrContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando QR Code...';

            const enrollRes = await auth.enrollMFA();

            if (enrollRes.error) {
                document.getElementById('mfa-error').textContent = enrollRes.error;
            document.getElementById('mfa-error').style.display = 'block';
            return;
            }

            window.mfaFactorId = enrollRes.id;
            qrContainer.innerHTML = enrollRes.qr_code;
        }

            function closeSecurityModal() {
                document.getElementById('security-modal').style.display = 'none';
            document.getElementById('mfa-error').style.display = 'none';
            document.getElementById('mfa-verify-code').value = '';
        }

            async function enableMFA() {
            const code = document.getElementById('mfa-verify-code').value;
            const errorEl = document.getElementById('mfa-error');

            if (code.length !== 6) {
                errorEl.textContent = 'Digite 6 dígitos';
            errorEl.style.display = 'block';
            return;
            }

            const auth = new AuthService();
            const verifyRes = await auth.challengeAndVerifyMFA(window.mfaFactorId, code);

            if (verifyRes.error) {
                errorEl.textContent = 'Código inválido ou expirado.';
            errorEl.style.display = 'block';
            } else {
                document.getElementById('mfa-step-1').style.display = 'none';
            document.getElementById('mfa-step-success').style.display = 'block';
            errorEl.style.display = 'none';
            }
        }
    </script>
</body>

</html>