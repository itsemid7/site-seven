<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários | Admin SEVEN</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="overlay" id="mobile-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="margin: 0;">SEVEN<span style="color: var(--color-red);">.</span></h3>
                <p style="font-size: 0.8rem; color: #666;">Painel Administrativo</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                <li><a href="products.html"><i class="fas fa-box"></i> Produtos</a></li>
                <li><a href="categories.html"><i class="fas fa-tags"></i> Categorias</a></li>
                <li><a href="users.html" class="active"><i class="fas fa-users"></i> Usuários</a></li>
                <li><a href="freight.html"><i class="fas fa-truck"></i> Frete</a></li>
                <li><a href="banners.html"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="#" onclick="openSecurityModal()"><i class="fas fa-shield-alt"></i> Segurança / 2FA</a></li>
                <li><a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="db.logout(); window.location.href='../login.html'"
                    style="color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="text-display">Gerenciar Usuários</h2>
            </div>

            <!-- Team Section -->
            <h3 class="section-title">Equipe Administrativa</h3>
            <div class="table-container">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="team-list">
                            <!-- Team members injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Customers Section -->
            <h3 class="section-title" style="margin-top: 30px;">Clientes Cadastrados</h3>
            <div class="table-container">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Data Cadastro</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="customers-list">
                            <!-- Customers injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div class="modal-content"
            style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
            <h3>Editar Usuário</h3>
            <form id="edit-user-form">
                <input type="hidden" id="edit-id">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Nome</label>
                    <input type="text" id="edit-name" required
                        style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Telefone</label>
                    <input type="text" id="edit-phone"
                        style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Função</label>
                    <select id="edit-role"
                        style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="customer">Cliente</option>
                        <option value="staff">Equipe</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" onclick="closeEditModal()"
                        style="padding: 8px 15px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 4px; cursor: pointer;">Cancelar</button>
                    <button type="submit"
                        style="padding: 8px 15px; border: none; background: #000; color: white; border-radius: 4px; cursor: pointer;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Modal (2FA) -->
    <div id="security-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSecurityModal()">&times;</span>
            <h3 style="margin-bottom: 20px;">Configurar 2FA</h3>

            <div id="mfa-step-1">
                <p>Escaneie o QR Code abaixo com seu aplicativo (Google Authenticator).</p>
                <div id="mfa-qr" style="margin: 20px 0; text-align: center;">Loading...</div>
                <div class="form-group">
                    <label>Código de Verificação (6 dígitos)</label>
                    <input type="text" id="mfa-verify-code" placeholder="123456" maxlength="6">
                </div>
                <button onclick="enableMFA()" class="btn-primary" style="width: 100%;">Ativar 2FA</button>
            </div>

            <div id="mfa-step-success" style="display: none; text-align: center;">
                <i class="fas fa-check-circle" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                <h4>2FA Ativado com Sucesso!</h4>
                <p>Agora seus logins pedirão esse código.</p>
                <button onclick="closeSecurityModal()" class="admin-btn-secondary"
                    style="margin-top: 15px;">Fechar</button>
            </div>

            <div id="mfa-active-msg" style="display: none; text-align: center; padding: 20px;">
                <i class="fas fa-shield-alt" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                <h4>Você já está protegido!</h4>
                <p>A Autenticação de Dois Fatores está ativa nesta conta.</p>
            </div>

            <div class="error-msg" id="mfa-error" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-init.js"></script>
    <script src="../assets/js/db.js"></script>
    <script src="../assets/js/api.js"></script>

    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        // Mobile Toggle Logic
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');

        if (mobileBtn) {
            mobileBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
        }

        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        // Render Users
        async function renderUsers() {
            const teamList = document.getElementById('team-list');
            const customersList = document.getElementById('customers-list');

            try {
                const users = await db.getUsers();

                // Filter users
                const team = users.filter(u => u.role === 'admin' || u.role === 'staff');
                const customers = users.filter(u => u.role === 'customer' || !u.role);

                // Render Team
                teamList.innerHTML = team.map(user => `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><span
                                    style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">${user.role
                        === 'admin' ? 'Administrador' : 'Equipe'}</span></td>
                            <td>
                                <button class="action-btn edit"
                                    onclick="openEditModal('${user.id}', '${user.name}', '${user.phone || ''}', '${user.role}')"
                                    style="background: #ffc107; color: #000; margin-right: 5px;"><i
                                        class="fas fa-pencil-alt"></i></button>
                                <button class="action-btn delete" onclick="deleteUser('${user.id}')"
                                    ${user.email === 'admin@seven.com' ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}><i
                                        class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        `).join('');

                if (team.length === 0) {
                    teamList.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum membro da equipe encontrado.</td></tr>';
                }

                // Render Customers
                customersList.innerHTML = customers.map(user => `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '-'}</td>
                            <td>${new Date(user.createdAt || Date.now()).toLocaleDateString('pt-BR')}</td>
                            <td>
                                <button class="action-btn edit"
                                    onclick="openEditModal('${user.id}', '${user.name}', '${user.phone || ''}', '${user.role}')"
                                    style="background: #ffc107; color: #000; margin-right: 5px;"><i
                                        class="fas fa-pencil-alt"></i></button>
                                <button class="action-btn delete" onclick="deleteUser('${user.id}')"><i
                                        class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        `).join('');

                if (customers.length === 0) {
                    customersList.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum cliente cadastrado.</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                customersList.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">Erro ao carregar usuários.</td></tr>';
            }
        }

        // Edit Modal Logic
        const editModal = document.getElementById('edit-user-modal');
        const editForm = document.getElementById('edit-user-form');

        window.openEditModal = (id, name, phone, role) => {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-phone').value = phone;
            document.getElementById('edit-role').value = role;
            editModal.style.display = 'flex';
        };

        window.closeEditModal = () => {
            editModal.style.display = 'none';
        };

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const role = document.getElementById('edit-role').value;

            try {
                await db.updateUser({ id, name, phone, role });
                closeEditModal();
                await renderUsers();
                alert('Usuário atualizado com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                alert('Erro ao atualizar usuário. Verifique se você tem permissão de administrador.');
            }
        });

        window.deleteUser = async (id) => {
            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                try {
                    const result = await db.deleteUser(id);
                    if (result) {
                        await renderUsers();
                    } else {
                        alert('Erro ao excluir usuário. Verifique as permissões.');
                    }
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                    alert('Erro ao excluir usuário.');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await renderUsers();

            // Debug Info
            try {
                const { data, error } = await db.client.rpc('get_my_info');
                if (data) {
                    console.log('Debug Info:', data);
                    // alert(`Debug: Você é ${data.profile_email} (${data.profile_role})`);
                }
            } catch (e) {
                console.error('Debug Error:', e);
            }
        });
    </script>
</body>

</html>