<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos | Admin SEVEN</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-shipped {
            background: #cce5ff;
            color: #004085;
        }

        .status-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .order-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-box h4 {
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .order-items-table th,
        .order-items-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="overlay" id="mobile-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="margin: 0;">SEVEN<span style="color: var(--color-red);">.</span></h3>
                <p style="font-size: 0.8rem; color: #666;">Painel Administrativo</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="orders.html" class="active"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                <li><a href="products.html"><i class="fas fa-box"></i> Produtos</a></li>
                <li><a href="categories.html"><i class="fas fa-tags"></i> Categorias</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Usuários</a></li>
                <li><a href="freight.html"><i class="fas fa-truck"></i> Frete</a></li>
                <li><a href="banners.html"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="db.logout(); window.location.href='../login.html'"
                    style="color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="text-display">Gerenciar Pedidos</h2>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list">
                            <!-- Orders injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title">Detalhes do Pedido #<span id="modal-order-id"></span></h3>
                <button onclick="closeOrderModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>

            <div class="order-details-grid">
                <div class="detail-box">
                    <h4>Cliente</h4>
                    <p><strong>Nome:</strong> <span id="detail-name"></span></p>
                    <p><strong>CPF:</strong> <span id="detail-cpf"></span></p>
                    <p><strong>Email:</strong> <span id="detail-email"></span></p>
                    <p><strong>Telefone:</strong> <span id="detail-phone"></span></p>
                </div>
                <div class="detail-box">
                    <h4>Entrega</h4>
                    <p id="detail-address"></p>
                    <p><strong>Frete:</strong> <span id="detail-freight"></span></p>
                </div>
            </div>

            <div class="detail-box">
                <h4>Itens do Pedido</h4>
                <table class="order-items-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Tam/Cor</th>
                            <th>Qtd</th>
                            <th>Preço Unit.</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="detail-items"></tbody>
                </table>
                <div style="text-align: right; margin-top: 15px; font-size: 1.1rem; font-weight: bold;">
                    Total: <span id="detail-total"></span>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <h4>Atualizar Status</h4>
                <div style="display: flex; gap: 10px;">
                    <select id="update-status" class="form-control" style="max-width: 200px;">
                        <option value="pending">Pendente</option>
                        <option value="paid">Pago</option>
                        <option value="shipped">Enviado</option>
                        <option value="delivered">Entregue</option>
                        <option value="cancelled">Cancelado</option>
                    </select>
                    <button class="btn-primary" onclick="updateStatus()">Salvar Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-init.js"></script>
    <script src="../assets/js/db.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        // Mobile Toggle Logic
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');

        if (mobileBtn) {
            mobileBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
        }

        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        // Order Management Logic
        let currentOrderId = null;
        let allOrders = [];

        async function renderOrders() {
            allOrders = await db.getOrders();
            const tbody = document.getElementById('orders-list');

            tbody.innerHTML = allOrders.map(o => {
                const date = new Date(o.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(o.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                return `
                <tr>
                    <td>#${o.id.slice(0, 8)}</td>
                    <td>${date}</td>
                    <td>${o.customer_name || 'Cliente Desconhecido'}</td>
                    <td>${app.formatCurrency(o.total)}</td>
                    <td><span class="status-badge status-${o.status}">${translateStatus(o.status)}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewOrder('${o.id}')"><i class="fas fa-eye"></i></button>
                    </td>
                </tr>
            `}).join('');

            if (allOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum pedido encontrado.</td></tr>';
            }
        }

        function translateStatus(status) {
            const map = {
                'pending': 'Pendente',
                'paid': 'Pago',
                'shipped': 'Enviado',
                'delivered': 'Entregue',
                'cancelled': 'Cancelado'
            };
            return map[status] || status;
        }

        // Modal Functions
        const modal = document.getElementById('order-modal');

        function viewOrder(id) {
            const order = allOrders.find(o => o.id === id);
            if (!order) return;

            currentOrderId = id;
            modal.style.display = 'flex';

            document.getElementById('modal-order-id').textContent = order.id.slice(0, 8);
            document.getElementById('detail-name').textContent = order.customer_name;
            document.getElementById('detail-cpf').textContent = order.customer_cpf || '-';
            document.getElementById('detail-email').textContent = order.customer_email;
            document.getElementById('detail-phone').textContent = order.customer_phone;

            // Handle address (support both flat columns and legacy nested object)
            const street = order.address_street || (order.address && order.address.street);
            const number = order.address_number || (order.address && order.address.number);
            const complement = order.address_complement || (order.address && order.address.complement);
            const neighborhood = order.address_neighborhood || (order.address && order.address.neighborhood);
            const city = order.address_city || (order.address && order.address.city);
            const state = order.address_state || (order.address && order.address.state);
            const cep = order.address_cep || (order.address && order.address.cep);

            if (street) {
                document.getElementById('detail-address').innerHTML = `
                    ${street}, ${number || 'S/N'} ${complement ? '- ' + complement : ''}<br>
                    ${neighborhood} - ${city}/${state}<br>
                    CEP: ${cep}
                `;
            } else {
                document.getElementById('detail-address').textContent = 'Endereço não disponível';
            }

            // Freight info
            const freightPrice = order.freight_price !== undefined ? order.freight_price : (order.freight && order.freight.price);
            const freightType = order.freight_type || (order.freight && order.freight.type);

            document.getElementById('detail-freight').textContent = freightPrice ? `${app.formatCurrency(freightPrice)} (${freightType || 'Padrão'})` : '-';

            document.getElementById('detail-total').textContent = app.formatCurrency(order.total);

            const itemsBody = document.getElementById('detail-items');
            if (order.items) {
                itemsBody.innerHTML = order.items.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.selectedSize || '-'} / ${item.selectedColor || '-'}</td>
                        <td>${item.quantity}</td>
                        <td>${app.formatCurrency(item.price)}</td>
                        <td>${app.formatCurrency(item.price * item.quantity)}</td>
                    </tr>
                `).join('');
            } else {
                itemsBody.innerHTML = '';
            }

            document.getElementById('update-status').value = order.status;
        }

        function closeOrderModal() {
            modal.style.display = 'none';
        }

        async function updateStatus() {
            const newStatus = document.getElementById('update-status').value;
            try {
                await db.updateOrderStatus(currentOrderId, newStatus);
                alert('Status atualizado com sucesso!');
                renderOrders();
                closeOrderModal();
            } catch (e) {
                console.error(e);
                alert('Erro ao atualizar status.');
            }
        }

        document.addEventListener('DOMContentLoaded', renderOrders);
    </script>
</body>

</html>