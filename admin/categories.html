<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorias | Admin SEVEN</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="overlay" id="mobile-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="margin: 0;">SEVEN<span style="color: var(--color-red);">.</span></h3>
                <p style="font-size: 0.8rem; color: #666;">Painel Administrativo</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                <li><a href="products.html"><i class="fas fa-box"></i> Produtos</a></li>
                <li><a href="categories.html" class="active"><i class="fas fa-tags"></i> Categorias</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Usuários</a></li>
                <li><a href="freight.html"><i class="fas fa-truck"></i> Frete</a></li>
                <li><a href="banners.html"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="#" onclick="openSecurityModal()"><i class="fas fa-shield-alt"></i> Segurança / 2FA</a></li>
                <li><a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="db.logout(); window.location.href='../login.html'"
                    style="color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="text-display">Gerenciar Categorias</h2>
                <button class="btn-primary" onclick="openCategoryModal()">
                    <i class="fas fa-plus"></i> Nova Categoria
                </button>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Imagem</th>
                                <th>Nome</th>
                                <th>Slug</th>
                                <th>Subcategorias</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="categories-list">
                            <!-- Categories injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Category Modal -->
            <div id="category-modal" class="modal">
                <div class="modal-content">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="modal-title" style="margin: 0;">Nova Categoria</h3>
                        <button onclick="closeCategoryModal()"
                            style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <form id="category-form">
                        <input type="hidden" id="category-id">
                        <div class="form-group">
                            <label class="form-label">Nome da Categoria</label>
                            <input type="text" id="category-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Slug (URL)</label>
                            <input type="text" id="category-slug" class="form-control" readonly
                                style="background: #eee;">
                        </div>

                        <!-- Image Upload Section -->
                        <div class="form-group">
                            <label class="form-label">Imagem de Capa</label>
                            <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="cat-upload-type" value="file" checked
                                        onchange="toggleCatUploadType()"> Upload
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="cat-upload-type" value="url"
                                        onchange="toggleCatUploadType()">
                                    Link
                                </label>
                            </div>

                            <div id="cat-file-input">
                                <input type="file" id="category-image" class="form-control" accept="image/*">
                                <input type="hidden" id="category-image-base64">
                            </div>
                            <div id="cat-url-input" style="display: none;">
                                <input type="url" id="category-url" class="form-control"
                                    placeholder="https://exemplo.com/imagem.jpg">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Subcategorias</label>
                            <div id="subcategories-container">
                                <!-- Subcategory fields injected here -->
                            </div>
                            <button type="button" class="btn-primary"
                                style="background: #e0e0e0; color: #333; margin-top: 10px; font-size: 0.9rem;"
                                onclick="addSubcategoryField()">
                                <i class="fas fa-plus"></i> Adicionar Subcategoria
                            </button>
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn-primary" style="background: #ccc; color: #333;"
                                onclick="closeCategoryModal()">Cancelar</button>
                            <button type="submit" class="btn-primary">Salvar Categoria</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Scripts -->
            <!-- Security Modal (2FA) -->
            <div id="security-modal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeSecurityModal()">&times;</span>
                    <h3 style="margin-bottom: 20px;">Configurar 2FA</h3>

                    <div id="mfa-step-1">
                        <p>Escaneie o QR Code abaixo com seu aplicativo (Google Authenticator).</p>
                        <div id="mfa-qr" style="margin: 20px 0; text-align: center;">Loading...</div>
                        <div class="form-group">
                            <label>Código de Verificação (6 dígitos)</label>
                            <input type="text" id="mfa-verify-code" placeholder="123456" maxlength="6">
                        </div>
                        <button onclick="enableMFA()" class="btn-primary" style="width: 100%;">Ativar 2FA</button>
                    </div>

                    <div id="mfa-step-success" style="display: none; text-align: center;">
                        <i class="fas fa-check-circle" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>2FA Ativado com Sucesso!</h4>
                        <p>Agora seus logins pedirão esse código.</p>
                        <button onclick="closeSecurityModal()" class="admin-btn-secondary"
                            style="margin-top: 15px;">Fechar</button>
                    </div>

                    <div id="mfa-active-msg" style="display: none; text-align: center; padding: 20px;">
                        <i class="fas fa-shield-alt" style="color: green; font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>Você já está protegido!</h4>
                        <p>A Autenticação de Dois Fatores está ativa nesta conta.</p>
                    </div>

                    <div class="error-msg" id="mfa-error" style="display: none; margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Scripts -->
            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <script src="../assets/js/supabase-init.js"></script>
            <script src="../assets/js/db.js"></script>
            <script src="../assets/js/api.js"></script>
            <script src="../assets/js/admin.js"></script>
            <script src="../assets/js/main.js"></script>
            <script>
                // Mobile Toggle Logic
                const mobileBtn = document.getElementById('mobile-menu-btn');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');

                if (mobileBtn) {
                    mobileBtn.addEventListener('click', () => {
                        sidebar.classList.toggle('active');
                        overlay.classList.toggle('active');
                    });
                }

                if (overlay) {
                    overlay.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                    });
                }

                // Category Management Logic
                async function renderCategories() {
                    const tbody = document.getElementById('categories-list');
                    try {
                        const categories = await db.getCategories();

                        if (!categories || categories.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma categoria cadastrada.</td></tr>';
                            return;
                        }

                        tbody.innerHTML = categories.map(c => `
                    <tr>
                        <td>
                            ${c.image ? `<img src="${c.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : '<span style="color:#ccc;">Sem img</span>'}
                        </td>
                        <td>${c.name}</td>
                        <td>${c.slug}</td>
                        <td>${c.subcategories ? c.subcategories.length : 0} subcategorias</td>
                        <td>
                            <button class="action-btn" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                    } catch (error) {
                        console.error('Erro ao renderizar categorias:', error);
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Erro ao carregar categorias.</td></tr>';
                    }
                }

                // Modal Functions
                const modal = document.getElementById('category-modal');
                const form = document.getElementById('category-form');

                function openCategoryModal(categoryId = null) {
                    modal.style.display = 'flex';
                    const container = document.getElementById('subcategories-container');
                    container.innerHTML = '';

                    // Reset Image Inputs
                    document.getElementById('category-image').value = '';
                    document.getElementById('category-image-base64').value = '';
                    document.getElementById('category-url').value = '';
                    toggleCatUploadType();

                    if (categoryId) {
                        // Edit mode
                        document.getElementById('modal-title').textContent = 'Editar Categoria';
                        // Load data logic handled in editCategory
                    } else {
                        // Add mode
                        document.getElementById('modal-title').textContent = 'Nova Categoria';
                        form.reset();
                        document.getElementById('category-id').value = '';
                    }
                }

                function closeCategoryModal() {
                    modal.style.display = 'none';
                }

                function toggleCatUploadType() {
                    const type = document.querySelector('input[name="cat-upload-type"]:checked').value;
                    const fileInput = document.getElementById('cat-file-input');
                    const urlInput = document.getElementById('cat-url-input');

                    if (type === 'file') {
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                    }
                }

                // Image Processing
                document.getElementById('category-image').addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            document.getElementById('category-image-base64').value = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Subcategory Logic
                function addSubcategoryField(name = '', slug = '', id = null) {
                    const container = document.getElementById('subcategories-container');
                    const div = document.createElement('div');
                    div.className = 'subcategory-item';
                    div.style.display = 'flex';
                    div.style.gap = '10px';
                    div.style.marginBottom = '10px';

                    div.innerHTML = `
                <input type="hidden" class="sub-id" value="${id || ''}">
                <input type="text" class="form-control sub-name" placeholder="Nome" value="${name}" required style="flex: 1;">
                <input type="text" class="form-control sub-slug" placeholder="Slug (Auto)" value="${slug}" readonly style="background: #eee; flex: 1;">
                <button type="button" class="btn-primary" style="background: #dc3545; padding: 0 15px;" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;

                    // Auto-generate slug for subcategory
                    const nameInput = div.querySelector('.sub-name');
                    const slugInput = div.querySelector('.sub-slug');

                    nameInput.addEventListener('input', () => {
                        slugInput.value = db.generateSlug(nameInput.value);
                    });

                    container.appendChild(div);
                }

                // Auto-generate slug for main category
                document.getElementById('category-name').addEventListener('input', (e) => {
                    document.getElementById('category-slug').value = db.generateSlug(e.target.value);
                });

                // Form Submit
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const subItems = document.querySelectorAll('.subcategory-item');
                    const subcategories = Array.from(subItems).map(item => ({
                        id: item.querySelector('.sub-id').value || Date.now() + Math.floor(Math.random() * 1000),
                        name: item.querySelector('.sub-name').value,
                        slug: item.querySelector('.sub-slug').value
                    }));

                    const categoryId = document.getElementById('category-id').value;

                    // Handle Image
                    const type = document.querySelector('input[name="cat-upload-type"]:checked').value;
                    let image = type === 'file'
                        ? document.getElementById('category-image-base64').value
                        : document.getElementById('category-url').value;

                    const category = {
                        name: document.getElementById('category-name').value,
                        slug: document.getElementById('category-slug').value,
                        subcategories: subcategories,
                        image: image // Add image
                    };

                    try {
                        if (categoryId) {
                            category.id = parseInt(categoryId);

                            // If no new image selected, keep old one? 
                            // Logic: If image is empty string, it might mean "no change" or "remove".
                            // For simplicity, if empty, we don't send it, but here we are sending it.
                            // Ideally we should fetch old one if new one is empty.
                            // But for now let's assume user re-uploads or we handle it in editCategory to pre-fill URL.

                            if (!image && document.getElementById('category-url').value === '') {
                                // If both empty, maybe we shouldn't update image?
                                // But we don't have the old image here easily without fetching.
                                // Let's rely on the user filling it or editCategory pre-filling it.
                            }

                            await db.updateCategory(category);
                            alert('Categoria atualizada com sucesso!');
                        } else {
                            await db.addCategory(category);
                            alert('Categoria criada com sucesso!');
                        }

                        closeCategoryModal();
                        await renderCategories();
                    } catch (error) {
                        console.error('Erro ao salvar:', error);
                        alert('Erro ao salvar categoria.');
                    }
                });

                // Mobile Toggle Logic
                const mobileBtn = document.getElementById('mobile-menu-btn');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');

                if (mobileBtn) {
                    mobileBtn.addEventListener('click', () => {
                        sidebar.classList.toggle('active');
                        overlay.classList.toggle('active');
                    });
                }

                if (overlay) {
                    overlay.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                    });
                }

                // Category Management Logic
                async function renderCategories() {
                    const tbody = document.getElementById('categories-list');
                    try {
                        const categories = await db.getCategories();

                        if (!categories || categories.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma categoria cadastrada.</td></tr>';
                            return;
                        }

                        tbody.innerHTML = categories.map(c => `
                            <tr>
                                <td>
                                    ${c.image ? `<img src="${c.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : '<span style="color:#ccc;">Sem img</span>'}
                                </td>
                                <td>${c.name}</td>
                                <td>${c.slug}</td>
                                <td>${c.subcategories ? c.subcategories.length : 0} subcategorias</td>
                                <td>
                                    <button class="action-btn" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            `).join('');
                    } catch (error) {
                        console.error('Erro ao renderizar categorias:', error);
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Erro ao carregar categorias.</td></tr>';
                    }
                }

                // Modal Functions
                const modal = document.getElementById('category-modal');
                const form = document.getElementById('category-form');

                function openCategoryModal(categoryId = null) {
                    modal.style.display = 'flex';
                    const container = document.getElementById('subcategories-container');
                    container.innerHTML = '';

                    // Reset Image Inputs
                    document.getElementById('category-image').value = '';
                    document.getElementById('category-image-base64').value = '';
                    document.getElementById('category-url').value = '';
                    toggleCatUploadType();

                    if (categoryId) {
                        // Edit mode
                        document.getElementById('modal-title').textContent = 'Editar Categoria';
                        // Load data logic handled in editCategory
                    } else {
                        // Add mode
                        document.getElementById('modal-title').textContent = 'Nova Categoria';
                        form.reset();
                        document.getElementById('category-id').value = '';
                    }
                }

                function closeCategoryModal() {
                    modal.style.display = 'none';
                }

                function toggleCatUploadType() {
                    const type = document.querySelector('input[name="cat-upload-type"]:checked').value;
                    const fileInput = document.getElementById('cat-file-input');
                    const urlInput = document.getElementById('cat-url-input');

                    if (type === 'file') {
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                    }
                }

                // Image Processing
                document.getElementById('category-image').addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            document.getElementById('category-image-base64').value = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Subcategory Logic
                function addSubcategoryField(name = '', slug = '', id = null) {
                    const container = document.getElementById('subcategories-container');
                    const div = document.createElement('div');
                    div.className = 'subcategory-item';
                    div.style.display = 'flex';
                    div.style.gap = '10px';
                    div.style.marginBottom = '10px';

                    div.innerHTML = `
                            <input type="hidden" class="sub-id" value="${id || ''}">
                                <input type="text" class="form-control sub-name" placeholder="Nome" value="${name}" required style="flex: 1;">
                                    <input type="text" class="form-control sub-slug" placeholder="Slug (Auto)" value="${slug}" readonly style="background: #eee; flex: 1;">
                                        <button type="button" class="btn-primary" style="background: #dc3545; padding: 0 15px;" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;

                    // Auto-generate slug for subcategory
                    const nameInput = div.querySelector('.sub-name');
                    const slugInput = div.querySelector('.sub-slug');

                    nameInput.addEventListener('input', () => {
                        slugInput.value = db.generateSlug(nameInput.value);
                    });

                    container.appendChild(div);
                }

                // Auto-generate slug for main category
                document.getElementById('category-name').addEventListener('input', (e) => {
                    document.getElementById('category-slug').value = db.generateSlug(e.target.value);
                });

                // Form Submit
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const subItems = document.querySelectorAll('.subcategory-item');
                    const subcategories = Array.from(subItems).map(item => ({
                        id: item.querySelector('.sub-id').value || Date.now() + Math.floor(Math.random() * 1000),
                        name: item.querySelector('.sub-name').value,
                        slug: item.querySelector('.sub-slug').value
                    }));

                    const categoryId = document.getElementById('category-id').value;

                    // Handle Image
                    const type = document.querySelector('input[name="cat-upload-type"]:checked').value;
                    let image = type === 'file'
                        ? document.getElementById('category-image-base64').value
                        : document.getElementById('category-url').value;

                    const category = {
                        name: document.getElementById('category-name').value,
                        slug: document.getElementById('category-slug').value,
                        subcategories: subcategories,
                        image: image // Add image
                    };

                    try {
                        if (categoryId) {
                            category.id = parseInt(categoryId);
                            await db.updateCategory(category);
                            alert('Categoria atualizada com sucesso!');
                        } else {
                            await db.addCategory(category);
                            alert('Categoria criada com sucesso!');
                        }

                        closeCategoryModal();
                        await renderCategories();
                    } catch (error) {
                        console.error('Erro ao salvar categoria:', error);
                        alert('Erro ao salvar categoria: ' + (error.message || error));
                    }
                });

                window.editCategory = async (id) => {
                    try {
                        const categories = await db.getCategories();
                        const category = categories.find(c => c.id === id);
                        if (!category) return;

                        document.getElementById('category-id').value = category.id;
                        document.getElementById('category-name').value = category.name;
                        document.getElementById('category-slug').value = category.slug;

                        openCategoryModal(id);

                        // Pre-fill Image
                        if (category.image) {
                            if (category.image.startsWith('http') && !category.image.startsWith('data:')) {
                                document.querySelector('input[name="cat-upload-type"][value="url"]').checked = true;
                                document.getElementById('category-url').value = category.image;
                                toggleCatUploadType();
                            } else {
                                document.querySelector('input[name="cat-upload-type"][value="file"]').checked = true;
                                document.getElementById('category-image-base64').value = category.image;
                                toggleCatUploadType();
                            }
                        } else {
                            document.querySelector('input[name="cat-upload-type"][value="file"]').checked = true;
                            document.getElementById('category-image').value = '';
                            document.getElementById('category-image-base64').value = '';
                            document.getElementById('category-url').value = '';
                            toggleCatUploadType();
                        }

                        // Pre-fill subcategories
                        const subcategoriesContainer = document.getElementById('subcategories-container');
                        subcategoriesContainer.innerHTML = '';
                        if (category.subcategories && category.subcategories.length > 0) {
                            category.subcategories.forEach(sub => addSubcategoryField(sub.name, sub.slug, sub.id));
                        }

                    } catch (error) {
                        console.error('Erro ao carregar categoria para edição:', error);
                        alert('Erro ao carregar categoria para edição.');
                    }
                };

                window.deleteCategory = async (id) => {
                    if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                        try {
                            await db.deleteCategory(id);
                            await renderCategories();
                        } catch (error) {
                            console.error('Erro ao excluir:', error);
                            alert('Erro ao excluir categoria.');
                        }
                    }
                };

                // Initialize
                document.addEventListener('DOMContentLoaded', renderCategories);
            </script>
</body>

</html>