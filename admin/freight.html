<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Frete | Admin SEVEN</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="overlay" id="mobile-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 style="margin: 0;">SEVEN<span style="color: var(--color-red);">.</span></h3>
                <p style="font-size: 0.8rem; color: #666;">Painel Administrativo</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                <li><a href="products.html"><i class="fas fa-box"></i> Produtos</a></li>
                <li><a href="categories.html"><i class="fas fa-tags"></i> Categorias</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Usuários</a></li>
                <li><a href="freight.html" class="active"><i class="fas fa-truck"></i> Frete</a></li>
                <li><a href="banners.html"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="db.logout(); window.location.href='../login.html'"
                    style="color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="text-display">Configuração de Frete</h2>
            </div>

            <form id="freight-form">
                <!-- Lalamove Config -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 1.1rem;"><i class="fas fa-motorcycle"></i> Lalamove (Motoboy)</h3>
                        <label class="toggle-switch">
                            <input type="checkbox" id="lalamove-active">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">CEP de Origem</label>
                        <input type="text" id="lalamove-origin" class="form-control" placeholder="00000-000"
                            maxlength="9">
                        <div id="address-display"
                            style="margin-top: 10px; font-size: 0.9rem; color: #666; font-style: italic;">
                        </div>
                    </div>

                    <h4 style="margin-bottom: 15px; margin-top: 30px; font-size: 1rem; color: #333;">Tabela de
                        Preços
                        (R$ por KM)</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">Defina o valor a ser somado
                        para
                        cada quilômetro específico.</p>

                    <div id="km-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px;">
                        <!-- Grid items generated by JS -->
                    </div>
                </div>

                <!-- Correios Config -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 1.1rem;"><i class="fas fa-box-open"></i> Correios (PAC/SEDEX)</h3>
                        <label class="toggle-switch">
                            <input type="checkbox" id="correios-active">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">PAC</h4>
                            <div class="form-group">
                                <label class="form-label">Preço Base</label>
                                <input type="text" id="pac-base" class="form-control" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Preço por Kg Adicional</label>
                                <input type="text" id="pac-kg" class="form-control" placeholder="0,00">
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">SEDEX</h4>
                            <div class="form-group">
                                <label class="form-label">Preço Base</label>
                                <input type="text" id="sedex-base" class="form-control" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Preço por Kg Adicional</label>
                                <input type="text" id="sedex-kg" class="form-control" placeholder="0,00">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn-primary">Salvar Configurações</button>
                    <button type="button" class="btn-primary" style="background: #dc3545;"
                        onclick="resetFreightConfig()">Restaurar Padrões</button>
                </div>
            </form>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-init.js"></script>
    <script src="../assets/js/db.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        // Mobile Toggle Logic
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');

        if (mobileBtn) {
            mobileBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
        }

        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        // Global Config State
        let currentConfig = {
            lalamove: { active: false, pricing_table: {} },
            correios: { active: false }
        };

        // Helper to format currency input
        function formatInput(value) {
            if (value === undefined || value === null) return '';
            return value.toString().replace('.', ',');
        }

        // Helper to parse currency input
        function parseInput(value) {
            if (!value) return 0;
            return parseFloat(value.replace(',', '.'));
        }

        // Generate KM Grid
        function generateKmGrid() {
            const grid = document.getElementById('km-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 50; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.style.marginBottom = '0';
                div.innerHTML = `
            <label class="form-label" style="font-size: 0.8rem;">Km ${i}</label>
            <input type="text" id="km-${i}" class="form-control" placeholder="0,00">
        `;
                grid.appendChild(div);
            }
        }

        // Address Fetch Logic
        const cepInput = document.getElementById('lalamove-origin');
        const addressDisplay = document.getElementById('address-display');

        function fetchAddress(cep) {
            if (cep.length === 8) {
                addressDisplay.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando endereço...';
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            addressDisplay.innerHTML = `
                        <i class="fas fa-map-marker-alt" style="color: var(--color-red);"></i> 
                        ${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}
                    `;
                        } else {
                            addressDisplay.innerHTML = '<span style="color: #dc3545;">CEP não encontrado.</span>';
                        }
                    })
                    .catch(() => {
                        addressDisplay.innerHTML = '<span style="color: #dc3545;">Erro ao buscar endereço.</span>';
                    });
            } else {
                addressDisplay.innerHTML = '';
            }
        }

        cepInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);

            // Mask
            if (value.length > 5) {
                e.target.value = value.slice(0, 5) + '-' + value.slice(5);
            } else {
                e.target.value = value;
            }

            if (value.length === 8) {
                fetchAddress(value);
            }
        });

        // Load Configuration
        async function loadConfig() {
            try {
                const config = await db.getConfig();
                if (config) {
                    currentConfig = config;

                    // Lalamove
                    if (currentConfig.lalamove) {
                        document.getElementById('lalamove-active').checked = currentConfig.lalamove.active;
                        document.getElementById('lalamove-origin').value = currentConfig.lalamove.origin_cep || '';

                        // Trigger address fetch if CEP exists
                        const cleanCep = (currentConfig.lalamove.origin_cep || '').replace(/\D/g, '');
                        if (cleanCep.length === 8) fetchAddress(cleanCep);

                        // Populate Pricing Table
                        if (currentConfig.lalamove.pricing_table) {
                            for (let i = 1; i <= 50; i++) {
                                const val = currentConfig.lalamove.pricing_table[i.toString()];
                                if (val !== undefined) {
                                    const input = document.getElementById(`km-${i}`);
                                    if (input) input.value = formatInput(val);
                                }
                            }
                        }
                    }

                    // Correios
                    if (currentConfig.correios) {
                        document.getElementById('correios-active').checked = currentConfig.correios.active;
                        document.getElementById('pac-base').value = formatInput(currentConfig.correios.pac_base);
                        document.getElementById('pac-kg').value = formatInput(currentConfig.correios.pac_kg);
                        document.getElementById('sedex-base').value = formatInput(currentConfig.correios.sedex_base);
                        document.getElementById('sedex-kg').value = formatInput(currentConfig.correios.sedex_kg);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                alert('Erro ao carregar configurações. Verifique o console.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            generateKmGrid();
            loadConfig();
        });

        // Save Settings
        document.getElementById('freight-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const pricingTable = {};
            for (let i = 1; i <= 50; i++) {
                const val = document.getElementById(`km-${i}`).value;
                if (val) pricingTable[i.toString()] = parseInput(val);
            }

            const newConfig = {
                lalamove: {
                    active: document.getElementById('lalamove-active').checked,
                    origin_cep: document.getElementById('lalamove-origin').value,
                    pricing_table: pricingTable
                },
                correios: {
                    active: document.getElementById('correios-active').checked,
                    pac_base: parseInput(document.getElementById('pac-base').value),
                    pac_kg: parseInput(document.getElementById('pac-kg').value),
                    sedex_base: parseInput(document.getElementById('sedex-base').value),
                    sedex_kg: parseInput(document.getElementById('sedex-kg').value)
                }
            };

            try {
                await db.saveConfig(newConfig);
                currentConfig = newConfig; // Update local state
                alert('Configurações de frete salvas com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações. Tente novamente.');
            }
        });

        async function resetFreightConfig() {
            if (confirm('Deseja restaurar as configurações padrão de frete?')) {
                const defaultConfig = {
                    lalamove: {
                        active: true,
                        origin_cep: '01001-000',
                        pricing_table: { "1": 5.0, "2": 7.0, "3": 9.0, "4": 10.0, "5": 12.0 }
                    },
                    correios: {
                        active: true,
                        pac_base: 20.0,
                        pac_kg: 5.0,
                        sedex_base: 35.0,
                        sedex_kg: 8.0
                    }
                };

                try {
                    await db.saveConfig(defaultConfig);
                    alert('Configurações restauradas! Recarregando...');
                    window.location.reload();
                } catch (error) {
                    console.error('Erro ao resetar configurações:', error);
                    alert('Erro ao resetar configurações.');
                }
            }
        }
    </script>
</body>

</html>